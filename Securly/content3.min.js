///////////////////////////////
// Google Search Content File//
///////////////////////////////

// Parses Google/search engine results and blocks your page if they are "inappropriate" or they fall into the category of "anonymous proxies"



// Big Brother is watching.



////// Begin Code //////


// Connects to Big Brother
var port = chrome.runtime.connect({
    name: "search_engine_parser"
});
let shContent = [];

// If the user is on Bing, run the BingIssueFix()
function onWindowLoad() {
    let e = document.querySelector("title");
    e ? checkTitle(e) : setTimeout(bingIssueFix, 2e3)
}

// Fixes some bug with searching that prevented securly from working properly.
function bingIssueFix() {
    if (-1 != document.location.hostname.indexOf("bing")) {
        let e = document.querySelector("input[type=search]");
        if (e && "" != e.value) {
            checkTitle(e.value + " - bing")
        }
    }
}

// Checks for flagged data.
function checkTitle(e) {
    if (e && "" == e.text) return;
    searchFlaggedData(e.text)
}

// Is it a Google? Is it a Bing? No! It's a Yahoo!
function searchFlaggedData(e) {
    let t = !1;
    for (let n = 0; n < shContent.length && (-1 != e.toLowerCase().indexOf("google") ? Array.from(document.getElementsByClassName("g")).map(function(o) {
            if (indexStr = o.innerHTML.toLowerCase().indexOf(shContent[n].toLowerCase()), -1 != indexStr) {
                var a = Array.from(o.getElementsByTagName("a"))[0].href;
                t || sendSHData(e.toLowerCase().replace("- google search", "").trim(), a, shContent[n], cleanDomainName(document.domain)), t = !0
            }
        }) : -1 != e.toLowerCase().indexOf("bing") ? Array.from(document.getElementsByClassName("b_algo")).map(function(o) {
            if (indexStr = o.innerHTML.toLowerCase().indexOf(shContent[n].toLowerCase()), -1 != indexStr) {
                var a = Array.from(o.getElementsByTagName("a"))[0].href;
                t || sendSHData(e.toLowerCase().replace("- bing", "").trim(), a, shContent[n], cleanDomainName(document.domain)), t = !0
            }
        }) : -1 != e.toLowerCase().indexOf("yahoo search") && Array.from(document.getElementsByClassName("relsrch")).map(function(o) {
            if (indexStr = o.innerHTML.toLowerCase().indexOf(shContent[n].toLowerCase()), -1 != indexStr) {
                var a = Array.from(o.getElementsByTagName("a"))[0].href;
                t || sendSHData(e.toLowerCase().replace("- yahoo search results", "").trim(), a, shContent[n], cleanDomainName(document.domain)), t = !0
            }
        }), !t); n++);
    if (!t)
        for (let n = 0; n < shContent.length && (url = "", document.documentElement.innerText.indexOf(shContent[n]) > 0 && (-1 != e.toLowerCase().indexOf("google") ? (t || sendSHData(e.toLowerCase().replace("- google search", "").trim(), url, shContent[n], cleanDomainName(document.domain)), t = !0) : -1 != e.toLowerCase().indexOf("bing") ? (t || sendSHData(e.toLowerCase().replace("- bing", "").trim(), url, shContent[n], cleanDomainName(document.domain)), t = !0) : -1 != e.toLowerCase().indexOf("yahoo search") && (t || sendSHData(e.toLowerCase().replace("- yahoo search results", "").trim(), url, shContent[n], cleanDomainName(document.domain)), t = !0)), !t); n++);
}

// YOUR PERSONAL INFORMATION BELONGS TO US.
function sendData(e) {
    port.postMessage({
        action: "fetchResult"
    })
}

// Sends yet more data to Big Brother!
function sendSHData(e, t, n, o) {
    port.postMessage({
        action: "sendSHResult",
        msg: e,
        url: t,
        matchedTerm: n,
        domain: o
    })
}

// I don't know what this does, but it seems harmless enough.
function cleanDomainName(e) {
    return e.replace(/^(?:https?:\/\/)?(?:www\.)?/i, "")
}

// I don't know why, but this calls the onwindowload function later than page load. Why?
function callWindowLoadWithTimeOut() {
    sendData(), setTimeout(onWindowLoad, 2e3)
}

// Recieve data from Big Brother.
port.onMessage.addListener(function(e) {
    shContent = e
}), window.addEventListener ? window.addEventListener("load", callWindowLoadWithTimeOut, !1) : window.attachEvent && window.attachEvent("onload", callWindowLoadWithTimeOut);